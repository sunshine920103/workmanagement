package com.workmanagement.util;

import java.io.BufferedInputStream;
import java.io.BufferedReader;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.servlet.http.HttpServletRequest;

import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.MultipartHttpServletRequest;

public class CSVUtil {
	
	public static List<List<String>> readCSVFile(HttpServletRequest request) throws IOException {
		InputStreamReader fr = null;
		BufferedReader br = null;
		MultipartHttpServletRequest multiRequest = (MultipartHttpServletRequest) request;
		MultipartFile mf = multiRequest.getFile("file");
		//获取文件编码格式
		String charset = getCharset(mf.getInputStream());
		System.out.println(charset);
		fr = new InputStreamReader(mf.getInputStream(),charset);
		
		br = new BufferedReader(fr);
		String rec = null;// 一行
		String str;// 一个单元格
		List<List<String>> listFile = new ArrayList<List<String>>();
		try {
			// 读取一行
			while ((rec = br.readLine()) != null) {
				Pattern pCells = Pattern
						.compile("(,)?((\"[^\"]*(\"{2})*[^\"]*\")*[^,]*)");
				Matcher mCells = pCells.matcher(rec);
				List<String> cells = new ArrayList<String>();// 每行记录一个list
				// 读取每个单元格
				while (mCells.find()) {
					String cell = mCells.group(2);//group(2) is ((\"[^\"]*(\"{2})*[^\"]*\")*[^,]*)  
			        Pattern pattern2 = Pattern.compile("\"((.)*)\"");  
			        Matcher matcher2 = pattern2.matcher(cell);  
			        if(matcher2.find()) {  
			            cell = matcher2.group(1);  
			        }
					cells.add(cell);
				}
				if(cells.size() > 0)
				{
					cells.remove(cells.size()-1);
				}
				
				listFile.add(cells);
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			if (fr != null) {
				fr.close();
			}
			if (br != null) {
				br.close();
			}
		}
		return listFile;
	}
	
	private static String getCharset(InputStream in) throws IOException{  
        
        BufferedInputStream bin = new BufferedInputStream(in);    
        int p = (bin.read() << 8) + bin.read();    
          
        String code = null;    
          
        switch (p) {    
            case 0xefbb:    
                code = "UTF-8";    
                break;    
            case 0xfffe:    
                code = "Unicode";    
                break;    
            case 0xfeff:    
                code = "UTF-16BE";    
                break;    
            default:    
                code = "GBK";    
        }    
        return code;  
}  
}
